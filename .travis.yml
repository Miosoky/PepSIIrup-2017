language: java
sudo: required
services:
 - docker
jdk:
 - oraclejdk8
node_js:
 - "7.5"
before_install:  
- npm install -g npm@2.14.5
- npm install -g cordova ionic
before_script:
  - wget https://dl.google.com/android/repository/tools_r25.1.7-linux.zip
  - unzip tools_r25.1.7-linux.zip
  - echo y | ./tools/android update sdk --no-ui --all --filter platform-tools
  - echo y | ./tools/android update sdk --no-ui --all --filter build-tools-25.0.1
  - echo y | ./tools/android update sdk --no-ui --all --filter android-25
  - echo y | ./tools/android update sdk --no-ui --all --filter extra-android-support
  - echo y | ./tools/android update sdk --no-ui --all --filter extra-android-m2repository
  - echo y | ./tools/android update sdk --no-ui --all --filter extra-google-m2repository
  - ls -l
  - export ANDROID_HOME=$PWD
  - export PATH=${PATH}:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/25.0.1
  - mkdir "$ANDROID_HOME/licenses"
  - echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > "$ANDROID_HOME/licenses/android-sdk-license"
script:  
- cd BackendMicroService
- mvn install 
- cd com.SII.RegisterService
- docker build -t eureka .
- cd ../com.SII.PersonneService
- docker build -t person .
- cd ../com.SII.EventService
- docker build -t event .
- cd ../com.SII.ClientService
- docker build -t client .
- cd ..
- docker-compose run
- cd ../Mobile-Ionic 
- npm install
- npm test
- chmod +x hooks/after_prepare/010_add_platform_class.js
- cordova platform add android
- ionic build android 
- cd ..

deploy:
  provider: releases
  file: "/home/travis/build/TraineeSIIp/PepSIIrup-2017/Mobile-Ionic/platforms/android/build/outputs/apk/android-debug.apk"
  file_glob: "true"
  skip_cleanup: true
  on:
    branch: master
    repo: TraineeSIIp/PepSIIrup-2017

after_success:
- sh set_tags.sh
    